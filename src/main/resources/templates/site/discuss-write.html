<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          crossorigin="anonymous">
    <link rel="icon" th:href="@{/img/icon.png}"/>
    <link rel="stylesheet" th:href="@{/tui-editor/css/toastui-editor.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/global.css}"/>
    <link
            rel="stylesheet"
            th:href="@{/tui-editor/css/tui-color-picker.min.css}"
    />
    <link
            rel="stylesheet"
            th:href="@{/tui-editor/css/toastui-editor-plugin-color-syntax.min.css}"
    />
    <link
            rel="stylesheet"
            th:href="@{/tui-editor/css/prism.min.css}"
    />
    <link
            rel="stylesheet"
            th:href="@{/tui-editor/css/toastui-editor-plugin-code-syntax-highlight.min.css}"
    />
    <link rel="stylesheet" th:href="@{/css/global.ui.css}"/>
    <link rel="stylesheet" th:href="@{/css/element-ui.css}"/>
    <link rel="stylesheet" th:href="@{/css/base.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.entry.css}"/>
    <link rel="stylesheet" th:href="@{/css/global-now.css}"/>
    <link rel="stylesheet" th:href="@{/tui-editor/css/my-editor.css}"/>
    <link rel="stylesheet" th:href="@{/css/discuss-write.css}"/>
    <title>YIDA社区-首页</title>
</head>
<body>
<div class="nk-container">
    <!-- 头部 -->
    <header class="bg-dark sticky-top" th:replace="index::header">
    </header>
    <div style="padding-top: 10px;width: 100%;">
        <div class=" topic-selected-box discuss-line clearfix">
            <div class="topic-publish">
                <input type="text" class="input-file-title" placeholder="SHOW YOU AMAZING TITLE !!!"
                       style="width: 100%;">
            </div>
        </div>
        <div id="editor" class="discuss-line"></div>
    </div>
</div>
<!-- 提示框 -->
<div class="modal fade" id="hintModal" tabindex="-1" role="dialog" aria-labelledby="hintModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hintModalLabel">提示</h5>
            </div>
            <div class="modal-body" id="hintBody">
                正在发布中......
            </div>
        </div>
    </div>
</div>
<!--话题标签板块选择modal框-->
<!--<div th:replace="/site/fragments/discuss-tag-modal::write-tag"></div>-->
<!-- Color Picker -->
<script th:src="@{/tui-editor/js/tui-color-picker.min.js}"></script>
<!-- Editor -->
<script th:src="@{/tui-editor/js/toastui-editor-all.js}"></script>
<!-- Editor's Plugin -->
<script th:src="@{/tui-editor/js/toastui-editor-plugin-color-syntax.min.js}"></script>
<script th:src="@{/tui-editor/js/toastui-editor-plugin-code-syntax-highlight-all.min.js}"></script>
<script th:src="@{/tui-editor/js/jquery-3.3.1.min.js}" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script th:src="@{/js/global.js}"></script>
<script type="text/javascript">
    function showTagModal() {
        $("#tagModal").css("display","block");
    }
    function publish(editor) {
        var content = editor.getMarkdown();
        // var htmlContent = editor.getHTML();
        var title = $(".input-file-title").val();
        var data = {title: title, content: content};
        $("#hintBody").text("正在发布中......");
        $("#hintModal").modal("show");
        showTagModal();
        if (title.trim().length === 0 || content.trim().length === 0) {
            var msg = "发布失败，标题和内容都不能为空！！！";
            afterCompletePublish(false, msg);
        } else {
            $.post(CONTEXT_PATH + "/discuss/post", data, function (data) {
                var success = false;
                if (data != null) {
                    data = $.parseJSON(data);
                    if (data && data.code === 200) {
                        success = true;
                    }
                    var msg = success ? data.msg : "【" + data.code + "】:" + data.msg;
                    afterCompletePublish(success, msg);
                } else {
                    afterCompletePublish(success, "ERROR:服务器异常,返回数据为空！！！");
                }
            })
        }
    }

    function afterCompletePublish(success, msg) {
        console.log($("#hintBody"))
        $("#hintBody").text(msg);
        setTimeout(function () {
            $("#hintModal").modal("hide");
            if (success) {
                location.href = "/";
            }
        }, 2000);
    }

    window.onload = () => {
        const {Editor} = toastui;
        const {colorSyntax, codeSyntaxHighlight} = Editor.plugin;
        const editor = new Editor({
            el: document.querySelector('#editor'),
            height: '640px',
            initialEditType: 'markdown',
            previewStyle: 'vertical',
            hideModeSwitch:true,
            viewer: true,
            plugins: [colorSyntax, codeSyntaxHighlight],
            initialValue: "# 互联网\n" +
                "- 哈哈\n" +
                "- 户籍\n" +
                "- <span style=\"color: #ba8baf\">你好</span>\n" +

                "- "
        });
        editor.insertToolbarItem({groupIndex: 6, itemIndex: 0}, {
            name: 'postCancel',
            text: '取消',
            className: 'toastui-editor-toolbar-discuss-cancel',
            style: {
                width: '80px', color: '#32ca99',
                borderRadius: '8px', border: '3px solid #32ca99'
            },
        });
        editor.insertToolbarItem({groupIndex: 6, itemIndex: 1}, {
            name: 'postPublish',
            text: '确认',
            className: 'btn btn-primary toastui-editor-toolbar-discuss-post',
            style: {
                width: '80px', color: '#fff',
                backgroundColor: '#32ca99', borderRadius: '8px'
            },
        });
        $(".toastui-editor-toolbar-discuss-post").click(_ => {
            publish(editor);
        })
    }
</script>
</body>
</html>